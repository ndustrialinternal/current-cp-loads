<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coincident Peak Program Current Peaks</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background-color: #f9f9f9; color: #333; }
    h1 { margin-bottom: 0.5rem; }
    h2 { margin-bottom: 1rem; font-size: 0.9rem; color: #555; }
    h3 { margin-top: 2rem; margin-bottom: 0.5rem; }
    section { margin-top: 2rem; padding: 1rem; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
    #loading-pjm, #loading-ercot { font-style: italic; color: #666; }
    .error { color: #c00; margin-top: 0.5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; margin-bottom: 1.5rem; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f0f0f0; }
    #data-controls {
      position: fixed; top: 1rem; right: 1rem;
      background: #fff; border: 1px solid #ddd; border-radius:4px;
      padding:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); z-index:1000;
    }
    #data-controls h4 { margin:0 0 .5rem; font-size:1rem; }
    #control-buttons { margin-bottom:.5rem; }
    #control-buttons button { margin-right:.5rem; }
    #data-controls label { display:block; margin-bottom:.25rem; cursor:pointer; }
    #data-controls input[type="checkbox"] { margin-right:.5rem; }
  </style>
</head>
<body>
  <button id="alerts-button"
          onclick="window.location.href='https://ndustrialinternal.github.io/amp-cp-alerts/';">
    Open Amp CP Alerts
  </button>

  <div id="data-controls" style="display:none;">
    <h4>Select Data</h4>
    <div id="control-buttons">
      <button id="select-all" type="button">Select All</button>
      <button id="clear-all"  type="button">Clear All</button>
    </div>
    <!-- checkboxes inserted here -->
  </div>

  <!-- PJM Section -->
  <section id="pjm-section">
    <h1>PJM Demand Top 5 Daily Peaks by Zone (ET)</h1>
    <div id="loading-pjm">Loading PJM data…</div>
    <div id="error-pjm" class="error" style="display:none;"></div>
    <div id="output-pjm" style="display:none;">
      <div id="tables-pjm"></div>
    </div>
  </section>

  <!-- ERCOT Monthly Section -->
  <section id="ercot-section">
    <h1>ERCOT Demand Top 5 Intervals per Month (CT)</h1>
    <h2>Top 5 15‑minute intervals each month</h2>
    <div id="loading-ercot">Loading ERCOT data…</div>
    <div id="error-ercot" class="error" style="display:none;"></div>
    <div id="output-ercot" style="display:none;">
      <div id="tables-ercot"></div>
    </div>
  </section>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ─── Supabase setup ──────────────────────────────────────────────────────
    const SUPABASE_URL      = 'https://jlmdkdeyemtbuoqzhmnk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbWRrZGV5ZW10YnVvcXpobW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzODczNzUsImV4cCI6MjA2ODk2MzM3NX0.D67p_so_Tkok6wCAt4_2w6xqVcrEC9wYnyohe0E7huc';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ─── Filters / State ─────────────────────────────────────────────────────
    const filters = [
      { key: 'AE',    label: 'AECO',  type: 'pjm' },
      { key: 'AEP',   label: 'AEP',   type: 'pjm' },
      { key: 'BC',    label: 'BGE',   type: 'pjm' },
      { key: 'COMED', label: 'COMED', type: 'pjm' },
      { key: 'DPL',   label: 'DPL',   type: 'pjm' },
      { key: 'PE',    label: 'PECO',  type: 'pjm' },
      { key: 'PS',    label: 'PSEG',  type: 'pjm' },
      { key: 'PL',    label: 'PPL',   type: 'pjm' },
      { key: 'ERCOT', label: 'ERCOT', type: 'ercot' },
    ];
    const zoneTopData = {};

    // ─── Build controls ──────────────────────────────────────────────────────
    const ctrl = document.getElementById('data-controls');
    filters.forEach(f => {
      const lbl = document.createElement('label');
      const cb  = document.createElement('input');
      cb.type    = 'checkbox';
      cb.value   = f.key;
      cb.checked = true;
      cb.addEventListener('change', onFilterChange);
      lbl.appendChild(cb);
      lbl.appendChild(document.createTextNode(f.label));
      ctrl.appendChild(lbl);
    });
    document.getElementById('select-all').onclick = () => {
      ctrl.querySelectorAll('input').forEach(cb => cb.checked = true);
      onFilterChange();
    };
    document.getElementById('clear-all').onclick = () => {
      ctrl.querySelectorAll('input').forEach(cb => cb.checked = false);
      onFilterChange();
    };

    function onFilterChange() {
      const checked = Array.from(ctrl.querySelectorAll('input:checked')).map(cb => cb.value);
      const showPJM   = checked.some(k => filters.find(f => f.key===k).type==='pjm');
      const showERCOT = checked.includes('ERCOT');

      document.getElementById('pjm-section').style.display   = showPJM   ? '' : 'none';
      document.getElementById('output-pjm').style.display    = showPJM   ? '' : 'none';
      document.getElementById('ercot-section').style.display = showERCOT ? '' : 'none';
      document.getElementById('output-ercot').style.display  = showERCOT ? '' : 'none';

      renderPJM(checked.filter(k => filters.find(f => f.key===k).type==='pjm'));
    }

    // ─── Render PJM table ─────────────────────────────────────────────────────
    function renderPJM(zoneKeys) {
      const container = document.getElementById('tables-pjm');
      container.innerHTML = '';
      zoneKeys.forEach(key => {
        const top = zoneTopData[key] || [];
        if (!top.length) return;

        const zone = filters.find(f => f.key === key);
        const h3 = document.createElement('h3');
        h3.textContent = zone.label;
        container.appendChild(h3);

        const tbl = document.createElement('table');
        tbl.innerHTML = `
          <thead>
            <tr>
              <th>Date (ET)</th>
              <th>Day</th>
              <th>End Time (ET)</th>
              <th>Load (MW)</th>
            </tr>
          </thead>
          <tbody>
            ${top.map(r => `
              <tr>
                <td>${r.date}</td>
                <td>${r.day}</td>
                <td>${r.endTime}</td>
                <td>${r.value.toLocaleString(undefined,{minimumFractionDigits:3})}</td>
              </tr>
            `).join('')}
          </tbody>`;
        container.appendChild(tbl);
      });
    }

    // ─── PJM: fetch from pjm_peaks ────────────────────────────────────────────
    (async function fetchPJM() {
      try {
        const { data, error } = await supabase
          .from('pjm_peaks')
          .select('interval_start_utc, zone, mw');
        if (error) throw error;

        filters.filter(f => f.type==='pjm').forEach(({ key }) => {
          const rows = data.filter(r => r.zone === key);
          zoneTopData[key] = rows.map(r => {
            const dt = new Date(r.interval_start_utc);
            return {
              date: dt.toLocaleDateString('en-US', {
                timeZone: 'America/New_York',
                year: 'numeric', month: '2-digit', day: '2-digit'
              }),
              day: dt.toLocaleDateString('en-US', {
                timeZone: 'America/New_York',
                weekday: 'short'
              }),
              endTime: dt.toLocaleTimeString('en-US', {
                timeZone: 'America/New_York',
                hour12: true,
                hour: '2-digit',
                minute: '2-digit'
              }),
              value: r.mw
            };
          });
        });

        document.getElementById('loading-pjm').style.display = 'none';
        ctrl.style.display = '';
        onFilterChange();
      } catch (e) {
        document.getElementById('loading-pjm').style.display = 'none';
        const err = document.getElementById('error-pjm');
        err.textContent = 'Error: ' + e.message;
        err.style.display = '';
      }
    })();

    // ─── ERCOT: fetch from ercot_peaks ────────────────────────────────────────
    (async function fetchERCOT() {
      try {
        const { data, error } = await supabase
          .from('ercot_peaks')
          .select(`
            interval_end_utc,
            cp,
            operational_load,
            dc_tie_imports,
            dc_tie_exports,
            wholesale_storage_load
          `);
        if (error) throw error;

        const byMonth = {};
        data.forEach(d => {
          const dt = new Date(d.interval_end_utc);
          const month = dt.toLocaleString('en-US',{
            timeZone:'America/Chicago',
            year:'numeric', month:'long'
          });
          (byMonth[month] ||= []).push(d);
        });

        const cont = document.getElementById('tables-ercot');
        Object.entries(byMonth).forEach(([month, arr]) => {
          const top5 = arr.slice(0,5);
          if (!top5.length) return;
          const h3 = document.createElement('h3'); h3.textContent = month;
          cont.appendChild(h3);

          const tbl = document.createElement('table');
          tbl.innerHTML = `
            <thead>
              <tr>
                <th>End Time (CT)</th><th>CP Load (MW)</th>
                <th>Int. Gen</th><th>DC In</th><th>DC Out</th><th>WSL</th>
              </tr>
            </thead>
            <tbody>
              ${top5.map(d => {
                const dt = new Date(d.interval_end_utc);
                return `
                  <tr>
                    <td>${dt.toLocaleString('en-US',{timeZone:'America/Chicago'})}</td>
                    <td>${d.cp.toLocaleString(undefined,{minimumFractionDigits:3})}</td>
                    <td>${d.operational_load?.toLocaleString(undefined,{minimumFractionDigits:3})||''}</td>
                    <td>${d.dc_tie_imports?.toLocaleString(undefined,{minimumFractionDigits:3})||''}</td>
                    <td>${d.dc_tie_exports?.toLocaleString(undefined,{minimumFractionDigits:3})||''}</td>
                    <td>${d.wholesale_storage_load?.toLocaleString(undefined,{minimumFractionDigits:3})||''}</td>
                  </tr>`;
              }).join('')}
            </tbody>`;
          cont.appendChild(tbl);
        });

        document.getElementById('loading-ercot').style.display = 'none';
        document.getElementById('output-ercot').style.display = '';
      } catch (e) {
        document.getElementById('loading-ercot').style.display = 'none';
        const err = document.getElementById('error-ercot');
        err.textContent = 'Error: ' + e.message;
        err.style.display = '';
      }
    })();
  </script>
</body>
</html>
