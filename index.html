<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Line Chart for ERCOT &amp; PJM with Monthly Thresholds (Hover Values)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f9f9f9; color: #333; }
    .controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    label { font-size: 0.9rem; }
    select, input[type=date] { padding: 0.25rem 0.5rem; font-size: 0.9rem; }
    #loading, #error { font-style: italic; color: #666; }
    #error { color: #c00; }
    canvas { background: #fff; border: 1px solid #ddd; border-radius: 4px; display: none; }
  </style>
</head>
<body>
  <h1>Daily Line Chart for ERCOT &amp; PJM</h1>

  <div class="controls">
    <label>
      Date:
      <input type="date" id="date-picker" />
    </label>
    <label>
      Data:
      <select id="data-selector">
        <option value="ercot">ERCOT CP</option>
        <option value="RTO">PJM RTO</option>
        <option value="AE">PJM AECO</option>
        <option value="AEP">PJM AEP</option>
        <option value="BC">PJM BGE</option>
        <option value="COMED">PJM COMED</option>
        <option value="DPL">PJM DPL</option>
        <option value="PE">PJM PECO</option>
        <option value="PS">PJM PSEG</option>
        <option value="PL">PJM PPL</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="show-threshold" />
      Show threshold line
    </label>
  </div>

  <div id="loading">Loading data…</div>
  <div id="error" style="display:none;"></div>
  <canvas id="line-chart" width="900" height="400"></canvas>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL      = 'https://jlmdkdeyemtbuoqzhmnk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbWRrZGV5ZW10YnVvcXpobW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzODczNzUsImV4cCI6MjA2ODk2MzM3NX0.D67p_so_Tkok6wCAt4_2w6xqVcrEC9wYnyohe0E7huc';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const dateInput     = document.getElementById('date-picker');
    const dataSelector  = document.getElementById('data-selector');
    const showThreshold = document.getElementById('show-threshold');
    const loadingEl     = document.getElementById('loading');
    const errorEl       = document.getElementById('error');
    const canvas        = document.getElementById('line-chart');
    const ctx           = canvas.getContext('2d');
    let chart;

    dateInput.value = new Date().toISOString().slice(0,10);
    [dateInput, dataSelector, showThreshold].forEach(el =>
      el.addEventListener('change', updateChart)
    );

    function fmtTime(iso, tz, opts) {
      return new Date(iso).toLocaleTimeString('en-US', { timeZone: tz, ...opts });
    }

    async function updateChart() {
      const date    = dateInput.value;
      const sel     = dataSelector.value;
      const include = showThreshold.checked;
      if (!date) return;

      loadingEl.style.display = '';
      errorEl.style.display   = 'none';
      canvas.style.display    = 'none';

      const isPJM   = sel !== 'ercot';
      const table   = isPJM ? 'pjm_hourly_load_metered' : 'gridstatus_ercot_15min';
      const tsCol   = isPJM ? 'interval_start_utc'     : 'interval_end_utc';
      const valCol  = isPJM ? 'mw'                     : 'cp';
      const tz      = isPJM ? 'America/New_York'       : 'America/Chicago';
      const offsetH = isPJM ? 4 : 5;
      const offsetMs = offsetH * 3600e3;

      const dayStartLocal = Date.parse(`${date}T00:00:00Z`);
      const dayEndLocal   = Date.parse(`${date}T23:59:59Z`);
      const startUTC = new Date(dayStartLocal + offsetMs).toISOString();
      const endUTC   = new Date(dayEndLocal + offsetMs).toISOString();

      try {
        let q = supabase
          .from(table)
          .select(`${tsCol}, ${valCol}`)
          .gte(tsCol, startUTC)
          .lte(tsCol, endUTC)
          .order(tsCol, { ascending: true });
        if (isPJM) q = q.eq('zone', sel);

        const { data, error } = await q;
        if (error) throw error;

        const labelsRaw = data.map(r =>
          fmtTime(r[tsCol], tz, { hour12:true, hour:'2-digit', minute:'2-digit' })
        );
        const categories = [...new Set(labelsRaw)];
        const values = categories.map(lbl =>
          (data.find(r =>
            fmtTime(r[tsCol], tz, { hour12:true, hour:'2-digit', minute:'2-digit' }) === lbl
          ) || {})[valCol] ?? null
        );

        const datasets = [{
          label: isPJM
            ? `PJM ${sel} Load (MW)`
            : `ERCOT CP (MW)`,
          data: values,
          tension: 0.2,
          fill: false,
          borderWidth: 2,
          pointHoverRadius: 0  // hide hover point for main series
        }];

        if (include) {
          if (isPJM) {
            const seasonStartLocal = Date.parse(`2025-06-01T00:00:00Z`);
            const seasonEndLocal   = Date.parse(`2025-10-01T00:00:00Z`);
            const seasonStartUTC   = new Date(seasonStartLocal + offsetMs).toISOString();
            const seasonEndUTC     = new Date(seasonEndLocal + offsetMs - 1).toISOString();

            const { data: peaks, error: peakErr } = await supabase
              .from('pjm_peaks')
              .select('mw')
              .eq('zone', sel)
              .gte('interval_start_utc', seasonStartUTC)
              .lte('interval_start_utc', seasonEndUTC)
              .order('mw', { ascending: false })
              .range(4,4);
            if (peakErr) throw peakErr;
            const threshold = peaks[0]?.mw || 0;

            datasets.push({
              label: 'PJM 5ᵗʰ‑highest daily peak',
              data: categories.map(() => threshold),
              borderColor: 'red',
              borderDash: [6,3],
              pointRadius: 0,
              pointHoverRadius: 6,    // show hover dot
              fill: false
            });
          } else {
            const [y, m] = date.split('-').map(Number);
            const monthStartLocal = Date.parse(`${y}-${String(m).padStart(2,'0')}-01T00:00:00Z`);
            const monthEndLocal   = Date.parse(`${y}-${String(m).padStart(2,'0')}-${String(new Date(y,m,0).getDate()).padStart(2,'0')}T23:59:59Z`);
            const monthStartUTC   = new Date(monthStartLocal + offsetMs).toISOString();
            const monthEndUTC     = new Date(monthEndLocal + offsetMs).toISOString();

            const { data: peaks, error: peakErr } = await supabase
              .from('ercot_peaks')
              .select('cp')
              .gte('interval_end_utc', monthStartUTC)
              .lte('interval_end_utc', monthEndUTC)
              .order('cp', { ascending: false })
              .limit(1);
            if (peakErr) throw peakErr;
            const threshold = peaks[0]?.cp || 0;

            datasets.push({
              label: 'ERCOT month‑to‑date max',
              data: categories.map(() => threshold),
              borderColor: 'red',
              borderDash: [6,3],
              pointRadius: 0,
              pointHoverRadius: 6,   // show hover dot
              fill: false
            });
          }
        }

        // Chart.js options with index-hover mode
        const options = {
          interaction: { mode: 'index', intersect: false },
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: items => `Interval ending: ${items[0].label}`,
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toLocaleString()} MW`
              }
            }
          },
          scales: {
            x: { title: { display:true, text:'Time' } },
            y: { title: { display:true, text:'MW' } }
          }
        };

        if (chart) {
          chart.data.labels   = categories;
          chart.data.datasets = datasets;
          chart.options       = options;
          chart.update();
          canvas.style.display = 'block';
        } else {
          canvas.style.display = 'block';
          chart = new Chart(ctx, {
            type: 'line',
            data: { labels: categories, datasets },
            options
          });
        }

        loadingEl.style.display = 'none';
      } catch (err) {
        loadingEl.style.display = 'none';
        errorEl.textContent     = 'Error: ' + err.message;
        errorEl.style.display   = '';
      }
    }

    updateChart();
  </script>
</body>
</html>
